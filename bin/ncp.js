var util = require('util'); var path = require('path');var net = require('net');var http = require('http');var dgram = require('dgram');var ws = require('../../ws');var fm = require('../../semantic.fm/bin/semantic.fm.js');var dm = require('../../semantic.dm/bin/semantic.dm.js');var act = require('../../semantic.node.actions/bin/semantic.node.actions.js');var mongodb = require('mongodb');var ncp={net:{}};ncp.net.udp={};ncp.net.ws={};ncp.net.http={};ncp.act={};ncp.act.ws={};ncp.db={};ncp.db.mongo={};ncp.cron={};ncp.tasks={};ncp.tasks.http={};ncp.net.udp.createSocket=function(){return dgram.createSocket("udp4")};ncp.net.udp.MulticastAgent=function(a,b,c,d){this.__host=a;this.__port=b;this.__message=c;this.__ttl=d;this.__startListening()};ncp.net.udp.MulticastAgent.prototype.__startListening=function(){var a=ncp.net.udp.createSocket(),b=this;a.on("listening",function(){a.setBroadcast(!0);a.setMulticastTTL(b.__ttl);a.addMembership(b.__host);b.__listen(a);b.__startMulticasting(a,b.__port,b.__host,b.__message,b.__ttl)})};
ncp.net.udp.MulticastAgent.prototype.__listen=function(a){a.on("message",function(a,c){console.log("[MulticastAgent] message received: %s (%s:%d)",a,c.address,c.port)})};ncp.net.udp.MulticastAgent.prototype.__startMulticasting=function(a,b,c,d,e){var f=new Buffer(d);setInterval(function(){a.send(f,0,f.length,b,c)},e)};ncp.net.udp.MulticastAgent.prototype.stopMulticasting=function(a){a.close()};ncp.net.udp.MulticastMessage={NEW_NODE:"new_node"};ncp.net.ws.Request=function(){};ncp.net.ws.IClient=function(){};ncp.net.ws.IClient.prototype.connect=function(a,b){};ncp.net.ws.IClient.prototype.send=function(a){};ncp.net.ws.Client=function(a,b){this.connect(a,b)};ncp.net.ws.Client.prototype.connect=function(a,b){var c=ws.connect("ws://"+a+":"+String(b));c.on("open",function(){console.log("[ncp.net.ws.Client] socket opened")});c.on("message",function(a){console.log("[ncp.net.ws.Client] message received: %s",a)})};ncp.net.ws.Client.prototype.send=function(a){};ncp.net.ws.IServer=function(){};ncp.net.ws.IServer.prototype.listen=function(a){};ncp.net.ws.Server=function(a){this.listen(a)};ncp.net.ws.Server.prototype.listen=function(a){function b(a){console.log("[ncp.net.ws.Server] message received: %s",a)}(new ws.Server({port:a})).on("connection",function(a){console.log("[ncp.net.ws.Server] connection created");a.on("message",b)})};ncp.net.http.IServer=function(){};ncp.net.http.IServer.prototype.listen=function(a){};ncp.net.http.IServer.prototype.registerTask=function(a,b){};ncp.net.http.Server=function(a){this.__port=a||80;this.__tasks={};this.listen(this.__port)};ncp.net.http.Server.prototype.listen=function(a){var b=this;http.createServer(function(a,d){a.on("data",function(){});a.on("end",function(){console.info(a.method+" "+a.url);var e=b.__tasks[a.url];"undefined"!==typeof e&&ncp.cron.add(new ncp.tasks.http.Context(e,d))})}).listen(a);console.info("[ncp.net.http.Server] listen on "+this.__port)};
ncp.net.http.Server.prototype.registerTask=function(a,b){this.__tasks[a]=b};ncp.act.ws.send=function(a,b,c){var d=c.get("client"),e=c.get("request");null!==d?null!==e?(d.send(e),a(c)):b("[ncp.act.ws.send] request is not defined"):b("[ncp.act.ws.send] client is not defined")};ncp.db.IRequest=function(){};ncp.db.IRequest.prototype.getType=function(){};ncp.db.IRequest.prototype.complete=function(a){};ncp.db.IRequest.prototype.cancel=function(a,b){};ncp.db.IClient=function(){};ncp.db.IClient.prototype.connect=function(a,b,c){};ncp.db.IClient.prototype.set=function(a,b,c,d,e){};ncp.db.IClient.prototype.get=function(a,b,c,d){};ncp.db.IClient.prototype.del=function(a,b,c,d){};ncp.db.IClient.prototype.add=function(a,b,c,d,e){};ncp.db.IClient.prototype.remove=function(a,b,c,d){};ncp.db.IClient.prototype.filter=function(a,b,c,d,e){};ncp.db.RequestType={GET:"get",SET:"set",DEL:"del",ADD:"add",FILTER:"filter"};ncp.db.mongo.createSetRequest=function(a,b,c,d,e){return new ncp.db.mongo.SetRequest(a,b,c,d,e)};ncp.db.mongo.createGetRequest=function(a,b,c,d){return new ncp.db.mongo.GetRequest(a,b,c,d)};ncp.db.mongo.IRequest=function(){};ncp.db.mongo.IRequest.prototype.getCollectionName=function(){};ncp.db.mongo.IRequest.prototype.getDocument=function(){};ncp.db.mongo.Request=function(a,b,c){this.__type=a;this.__complete=b;this.__cancel=c};ncp.db.mongo.Request.prototype.getType=function(){return this.__type};ncp.db.mongo.Request.prototype.complete=function(){return this.__complete};ncp.db.mongo.Request.prototype.cancel=function(){return this.__cancel};ncp.db.mongo.Request.prototype.getCollectionName=function(){return""};ncp.db.mongo.Request.prototype.getDocument=function(){return{}};ncp.db.mongo.SetRequest=function(a,b,c,d,e){ncp.db.mongo.Request.call(this,ncp.db.RequestType.SET,d,e);this.__collectionName=a;this.__document={key:b,value:c}};util.inherit(ncp.db.mongo.SetRequest,ncp.db.mongo.Request);ncp.db.mongo.SetRequest.prototype.getCollectionName=function(){return this.__collectionName};ncp.db.mongo.SetRequest.prototype.getDocument=function(){return this.__document};ncp.db.mongo.GetRequest=function(a,b,c,d){ncp.db.mongo.Request.call(this,ncp.db.RequestType.GET,c,d);this.__collectionName=a;this.__document={key:b}};util.inherit(ncp.db.mongo.GetRequest,ncp.db.mongo.Request);ncp.db.mongo.GetRequest.prototype.getCollectionName=function(){return this.__collectionName};ncp.db.mongo.GetRequest.prototype.getDocument=function(){return this.__document};ncp.db.mongo.Client=function(a,b,c){this.connect(c||"127.0.0.1",b,a);this.__core=null;this.__requests=[]};ncp.db.mongo.Client.prototype.connect=function(a,b,c){var d=this;mongodb.mongo.Client.connect("mongodb://"+a+":"+String(b)+"/"+c,function(a,b){null!==a?console.error("[ncp.db.mongo.Client] connect: "+a.toString()):(d.__core=b,d.__flush())})};ncp.db.mongo.Client.prototype.__flush=function(){for(var a=0,b=this.__requests.length;a<b;)this.__send(this.__requests[a]),a+=1};
ncp.db.mongo.Client.prototype.__send=function(a){a instanceof ncp.db.mongo.SetRequest&&this.__sendSetRequest(a);a instanceof ncp.db.mongo.GetRequest&&this.__sendGetRequest(a)};ncp.db.mongo.Client.prototype.__sendSetRequest=function(a){var b=a.getCollectionName(),c=a.getDocument();this.__core.collection(b).insert(c,{w:1},function(b,c){null===b?a.complete(c):a.cancel(b.toString())})};
ncp.db.mongo.Client.prototype.__sendGetRequest=function(a){var b=a.getCollectionName(),c=a.getDocument();this.__core.collection(b).find(c).toArray(function(b,c){null===b?a.complete(c):a.cancel(b.toString())})};ncp.db.mongo.Client.prototype.set=function(a,b,c,d,e){this.__requests.push(ncp.db.mongo.createSetRequest(a,b,c,d,e));this.__flush()};ncp.db.mongo.Client.prototype.get=function(a,b,c,d){this.__requests.push(ncp.db.mongo.createGetRequest(a,b,c,d));this.__flush()};
ncp.db.mongo.Client.prototype.del=function(a,b){};ncp.db.mongo.Client.prototype.add=function(a,b,c){};ncp.db.mongo.Client.prototype.remove=function(a,b,c,d){};ncp.db.mongo.Client.prototype.filter=function(a,b,c){};ncp.cron.ITask=function(){};ncp.cron.ITask.prototype.exec=function(){};ncp.cron.__TICK_INTERVAL=100;ncp.cron.__tasks=new ds.Queue(ncp.cron.ITask);ncp.cron.__timer=-1;ncp.cron.add=function(a){ncp.cron.__tasks.enqueue(a);-1===ncp.cron.__timer&&ncp.cron.__process()};ncp.cron.__process=function(){for(;!ncp.cron.__tasks.isEmpty();)ncp.cron.__tasks.dequeue().exec();ncp.cron.__tasks.isEmpty()?ncp.cron.__timer=-1:ncp.cron.__timer=setTimeout(ncp.cron.__process,ncp.cron.__TICK_INTERVAL)};ncp.tasks.ITask=function(){};ncp.tasks.ITask.prototype.getScript=function(){};ncp.tasks.IContext=function(){};ncp.tasks.IContext.prototype.processInput=function(a,b,c){};ncp.tasks.IContext.prototype.processOutput=function(a,b,c){};ncp.tasks.IContext.prototype.exec=function(){};ncp.tasks.IContext.prototype.complete=function(a){};ncp.tasks.IContext.prototype.cancel=function(a,b){};ncp.tasks.Task=function(a){this.__script=a};ncp.tasks.Task.prototype.getScript=function(){return this.__script};ncp.tasks.Context=function(a){this.__task=a};ncp.tasks.Context.prototype.processInput=function(a,b,c){a(c)};ncp.tasks.Context.prototype.processOutput=function(a,b,c){a(c)};ncp.tasks.Context.prototype.complete=function(a){};ncp.tasks.Context.prototype.cancel=function(a,b){console.error(a)};ncp.tasks.Context.prototype.exec=function(){var a=this;fm.script([this.processInput,this.__task.getScript(),this.processOutput])(function(b){a.complete.call(a,b)},this.cancel,null)};ncp.tasks.http.Context=function(a,b){ncp.tasks.Context.call(this,a);this.__response=b};util.inherits(ncp.tasks.http.Context,ncp.tasks.Context);ncp.tasks.http.Context.prototype.complete=function(a){"string"===typeof a&&(this.__response.setHeader("Content-Type","application/json"),this.__response.statusCode=200,this.__response.end(a))};
ncp.tasks.http.Context.prototype.cancel=function(a,b){ncp.tasks.Context.prototype.cancel(a,b);this.__response.setHeader("Content-Type","application/json");this.__response.statusCode=b||500;this.__response.end("")};ncp.tasks.http.Context.prototype.processOutput=function(a,b,c){a(ncp.tasks.http.createPacket(c))};ncp.tasks.http.createPacket=function(a){return JSON.stringify({data:a})};ncp.Agent=function(a,b,c){this.__udpAgent=a;this.__wsServer=b;this.__wsClient=c};module.exports = ncp;
